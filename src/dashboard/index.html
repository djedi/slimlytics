---
layout: base.njk
title: Analytics Dashboard
---

{% include "header.njk" %}

<div class="container" x-data="dashboard()" x-init="init()">
  <!-- Dashboard Controls -->
  <div class="dashboard-controls" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <div style="display: flex; align-items: center; gap: 1rem;">
      <!-- Real-time Status Indicator -->
      <div class="realtime-status" 
           :class="{ 'connected': wsConnected, 'disconnected': !wsConnected }"
           :title="wsConnected ? 'Real-time updates active' : 'Connecting to real-time updates...'"
           style="display: flex; align-items: center; gap: 5px; font-size: 12px; padding: 4px 8px; border-radius: 12px; background: rgba(52, 152, 219, 0.1);">
        <span class="status-dot" 
              style="width: 8px; height: 8px; border-radius: 50%; animation: pulse 2s infinite;"
              :style="{ background: wsConnected ? '#27ae60' : '#e74c3c' }"></span>
        <span x-text="wsConnected ? 'Live' : 'Connecting...'"></span>
      </div>
    </div>

    <!-- Date Range Selector -->
    <div class="date-selector">
      <button
        class="dropdown-btn"
        @click="dateDropdownOpen = !dateDropdownOpen"
      >
        <span class="emoji-icon">ğŸ“…</span>
        <span x-text="dateRanges[selectedDateRange]"></span>
        <span style="margin-left: auto">â–¼</span>
      </button>
      <div
        class="dropdown-menu"
        x-show="dateDropdownOpen"
        @click.outside="dateDropdownOpen = false"
        x-cloak
      >
        <template x-for="[key, value] in Object.entries(dateRanges)" :key="key">
          <div
            class="dropdown-item"
            :class="{'active': selectedDateRange === key}"
            @click="selectDateRange(key)"
          >
            <span x-text="value"></span>
          </div>
        </template>
      </div>
    </div>
  </div>

  <!-- Main Dashboard Grid -->
  <div class="dashboard-grid">
    <!-- Column 1 -->
    <div>
      <!-- The Basics -->
      <div class="card">
        <div class="card-header">
          <span class="emoji-icon">ğŸ“Š</span>
          The Basics
        </div>
        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-value" x-text="stats.visitors">0</div>
            <div class="stat-label">ğŸ‘¥ Visitors</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" x-text="stats.pageViews">0</div>
            <div class="stat-label">ğŸ“„ Page Views</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" x-text="stats.avgSessionDuration">0s</div>
            <div class="stat-label">â³ Avg Session</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" x-text="stats.bounceRate">0%</div>
            <div class="stat-label">ğŸ“‰ Bounce Rate</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" x-text="realtimeVisitors">0</div>
            <div class="stat-label">ğŸŸ¢ Online Now</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" x-text="topPages.length">0</div>
            <div class="stat-label">ğŸ“Š Active Pages</div>
          </div>
        </div>
      </div>

      <!-- Recent Visitors -->
      <div class="card">
        <div class="card-header">
          <span class="emoji-icon">ğŸ•</span>
          Recent Visitors
        </div>
        <ul class="data-list" style="font-family: monospace; font-size: 13px;">
          <template x-for="visitor in recentVisitors.slice(0, 10)" :key="visitor.visitor_id + visitor.timestamp">
            <li class="list-item" style="padding: 8px 15px; display: flex; align-items: center; gap: 8px;">
              <span style="color: #7f8c8d; min-width: 45px;" x-text="formatTimeShort(visitor.timestamp)"></span>
              <span class="country-flag" x-text="getFlagEmoji(visitor.country_code)"></span>
              <span style="min-width: 140px;" x-text="visitor.ip_address || visitor.ip_hash"></span>
              <a :href="visitor.page_url" target="_blank" class="content-link" x-text="getPathFromUrl(visitor.page_url)"></a>
            </li>
          </template>
          <li class="list-item" x-show="recentVisitors.length === 0" style="text-align: center; font-family: inherit;">
            <span style="color: #999;">No recent visitors yet</span>
          </li>
        </ul>
      </div>

      <!-- Links (Referrers) -->
      <div class="card">
        <div class="card-header">
          <span class="emoji-icon">ğŸ”—</span>
          Links
        </div>
        <ul class="data-list">
          <template x-for="referrer in topReferrers.slice(0, 8)" :key="referrer.referrer">
            <li class="list-item">
              <span><a href="#" class="link" x-text="referrer.referrer || 'direct'"></a></span>
              <span class="badge primary" x-text="referrer.count"></span>
            </li>
          </template>
          <li class="list-item" x-show="topReferrers.length === 0">
            <span style="color: #999;">No referrers yet</span>
          </li>
        </ul>
      </div>

      <!-- Searches -->
      <div class="card">
        <div class="card-header">
          <span class="emoji-icon">ğŸ”</span>
          Searches
        </div>
        <ul class="data-list">
          <template x-for="search in searchQueries" :key="search.query">
            <li class="list-item">
              <span x-text='`"${search.query}"`'></span>
              <span class="badge success" x-text="search.count"></span>
            </li>
          </template>
          <li class="list-item" x-show="searchQueries.length === 0">
            <span style="color: #999;">No search queries yet</span>
          </li>
        </ul>
      </div>

      <!-- Top Countries -->
      <div class="card">
        <div class="card-header">
          <span class="emoji-icon">ğŸŒ</span>
          Top Countries
        </div>
        <ul class="data-list">
          <template x-for="country in topCountries.slice(0, 8)" :key="country.countryCode">
            <li class="list-item">
              <span>
                <span x-text="getFlagEmoji(country.countryCode)"></span>
                <span x-text="country.country || 'Unknown'"></span>
              </span>
              <span class="badge primary" x-text="country.count"></span>
            </li>
          </template>
          <li class="list-item" x-show="topCountries.length === 0">
            <span style="color: #999;">No location data yet</span>
          </li>
        </ul>
      </div>

      <!-- Top Cities -->
      <div class="card">
        <div class="card-header">
          <span class="emoji-icon">ğŸ™ï¸</span>
          Top Cities
        </div>
        <ul class="data-list">
          <template x-for="city in topCities.slice(0, 8)" :key="city.city + city.country">
            <li class="list-item">
              <span>
                <span x-text="city.city || 'Unknown'"></span>
                <span style="color: #666; font-size: 0.9em;" x-text="city.country ? ', ' + city.country : ''"></span>
              </span>
              <span class="badge primary" x-text="city.count"></span>
            </li>
          </template>
          <li class="list-item" x-show="topCities.length === 0">
            <span style="color: #999;">No city data yet</span>
          </li>
        </ul>
      </div>
    </div>

    <!-- Column 2 -->
    <div>
      <!-- Visitors Chart -->
      <div class="card">
        <div class="card-header">
          <span class="emoji-icon">ğŸ“ˆ</span>
          Visitors
          <select
            style="
              margin-left: auto;
              padding: 5px;
              border: 1px solid #ddd;
              border-radius: 4px;
            "
          >
            <option>Compare to: 7 days ago</option>
            <option>Compare to: Yesterday</option>
            <option>Compare to: 28 days ago</option>
          </select>
        </div>
        <div class="chart-container" x-html="chartSvg"></div>
      </div>

      <!-- Content -->
      <div class="card">
        <div class="card-header">
          <span class="emoji-icon">ğŸ“„</span>
          Content
        </div>
        <ul class="data-list">
          <template x-for="(page, index) in topPages.slice(0, 10)" :key="page.url">
            <li class="list-item">
              <a :href="page.url" target="_blank" class="content-link" x-text="getPathFromUrl(page.url)"></a>
              <div style="display: flex; align-items: center; gap: 10px">
                <span class="badge" x-text="`${page.views} views`"></span>
                <div class="progress-bar" style="width: 100px">
                  <div class="progress-fill" :style="`width: ${topPages[0] ? (page.views / topPages[0].views * 100) : 0}%`"></div>
                </div>
              </div>
            </li>
          </template>
          <li class="list-item" x-show="topPages.length === 0">
            <span style="color: #999;">No page views yet</span>
          </li>
        </ul>
      </div>

      <!-- Locale -->
      <div class="card">
        <div class="card-header">
          <span class="emoji-icon">ğŸŒ</span>
          Locale
        </div>
        <ul class="data-list">
          <template x-for="locale in topLocales.slice(0, 6)" :key="locale.locale">
            <li class="list-item">
              <span>
                <span class="country-flag" x-text="getLocaleFlagEmoji(locale.locale)"></span>
                <span x-text="locale.language"></span>
                <span style="color: #7f8c8d; font-size: 0.85em;" x-text="locale.country ? `(${locale.country})` : ''"></span>
              </span>
              <div style="display: flex; align-items: center; gap: 10px">
                <span class="badge warning" x-text="locale.count"></span>
                <div class="progress-bar" style="width: 100px">
                  <div class="progress-fill" :style="`width: ${locale.percentage}%`"></div>
                </div>
                <span style="color: #7f8c8d; font-size: 12px" x-text="`${locale.percentage}%`"></span>
              </div>
            </li>
          </template>
          <li class="list-item" x-show="topLocales.length === 0">
            <span style="color: #999;">No locale data yet</span>
          </li>
        </ul>
      </div>

      <!-- Traffic Sources -->
      <div class="card">
        <div class="card-header">
          <span class="emoji-icon">ğŸš¦</span>
          Traffic Sources
        </div>
        <ul class="data-list">
          <template x-for="source in trafficSources" :key="source.source">
            <li class="list-item">
              <span>
                <span x-text="source.icon"></span>
                <span x-text="source.source"></span>
              </span>
              <div style="display: flex; align-items: center; gap: 10px">
                <span class="badge primary" x-text="source.count"></span>
                <span style="color: #7f8c8d; font-size: 12px" x-text="`${source.percentage}%`"></span>
              </div>
            </li>
          </template>
          <li class="list-item" x-show="trafficSources.length === 0">
            <span style="color: #999;">No traffic data yet</span>
          </li>
        </ul>
      </div>
    </div>
  </div>
</div>

<script src="/js/dashboard.js"></script>
