---
layout: base.njk
title: Add Site
---

<div class="container" x-data="addSite()" x-init="init()">
    <!-- Header -->
    <div class="header">
        <div style="display: flex; align-items: center; gap: 20px;">
            <img src="/images/slimlytics.png" alt="Slimlytics" style="height: 40px; width: auto;">
            <h1 style="font-size: 24px; color: #2c3e50; margin: 0;" x-text="hasExistingSites ? 'Add New Site' : 'Add Your First Site'">Add Your First Site</h1>
        </div>
        <a x-show="hasExistingSites" href="/" style="background: #6c757d; color: white; text-decoration: none; padding: 8px 16px; border-radius: 5px; font-size: 14px;">
            ‚Üê Back to Dashboard
        </a>
    </div>

    <!-- Add Site Form -->
    <div class="card" style="max-width: 600px; margin: 0 auto;">
        <div class="card-header">
            <span class="emoji-icon">üåê</span>
            Site Configuration
        </div>
        
        <form @submit.prevent="addSite()">
            <div style="margin-bottom: 20px;">
                <label for="siteName" style="display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50;">
                    Site Name
                </label>
                <input type="text" 
                       id="siteName"
                       x-model="siteName" 
                       placeholder="My Awesome Website"
                       required
                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                <div style="margin-top: 5px; font-size: 12px; color: #7f8c8d;">
                    A friendly name to identify your site in the dashboard
                </div>
            </div>

            <div style="margin-bottom: 20px;">
                <label for="siteUrl" style="display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50;">
                    Site URL
                </label>
                <input type="url" 
                       id="siteUrl"
                       x-model="siteUrl" 
                       placeholder="https://example.com"
                       required
                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                <div style="margin-top: 5px; font-size: 12px; color: #7f8c8d;">
                    The full URL of the website you want to track
                </div>
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button type="submit" 
                        style="background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: 600; transition: background 0.2s;"
                        :disabled="loading"
                        @mouseover="this.style.background='#2980b9'" 
                        @mouseout="this.style.background='#3498db'">
                    <span x-show="!loading">üöÄ Add Site</span>
                    <span x-show="loading">‚è≥ Adding...</span>
                </button>
            </div>
        </form>

        <div x-show="error" x-cloak 
             style="margin-top: 20px; padding: 10px; background: #fee; border: 1px solid #fcc; border-radius: 5px; color: #c00;">
            <span class="emoji-icon">‚ö†Ô∏è</span> <span x-text="error"></span>
        </div>
    </div>

    <!-- Success State with Tracking Code -->
    <div x-show="siteAdded" x-cloak class="card" style="max-width: 800px; margin: 20px auto;">
        <div class="card-header" style="background: #d4edda; color: #155724;">
            <span class="emoji-icon">‚úÖ</span>
            Site Added Successfully!
        </div>
        
        <div style="margin-bottom: 20px;">
            <h3 style="margin-bottom: 10px; color: #2c3e50;">üìä Tracking Code</h3>
            <p style="margin-bottom: 10px; color: #7f8c8d;">
                Add this code to your website, just before the closing &lt;/body&gt; tag:
            </p>
            <div style="position: relative;">
                <pre style="background: #f8f9fa; padding: 15px; border-radius: 5px; overflow-x: auto; border: 1px solid #dee2e6;"><code x-text="trackingCode"></code></pre>
                <button @click="copyTrackingCode()" 
                        style="position: absolute; top: 10px; right: 10px; background: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 12px;">
                    <span x-text="copyButtonText"></span>
                </button>
            </div>
        </div>

        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e9ecef;">
            <a href="/" style="display: inline-block; background: #3498db; color: white; text-decoration: none; padding: 10px 20px; border-radius: 5px; font-weight: 600;">
                üéØ Go to Dashboard
            </a>
        </div>
    </div>

    <!-- Info Box -->
    <div class="card" style="max-width: 600px; margin: 20px auto; background: #f8f9fa;">
        <div class="card-header">
            <span class="emoji-icon">üí°</span>
            Getting Started
        </div>
        <ul style="list-style: none; padding: 0;">
            <li style="padding: 10px 0; border-bottom: 1px solid #e9ecef;">
                <span class="emoji-icon">1Ô∏è‚É£</span> Add your site details above
            </li>
            <li style="padding: 10px 0; border-bottom: 1px solid #e9ecef;">
                <span class="emoji-icon">2Ô∏è‚É£</span> Copy the tracking code
            </li>
            <li style="padding: 10px 0; border-bottom: 1px solid #e9ecef;">
                <span class="emoji-icon">3Ô∏è‚É£</span> Paste it into your website's HTML
            </li>
            <li style="padding: 10px 0;">
                <span class="emoji-icon">4Ô∏è‚É£</span> Start viewing your analytics!
            </li>
        </ul>
    </div>
</div>

<script>
function addSite() {
    return {
        siteName: '',
        siteUrl: '',
        siteId: null,
        loading: false,
        error: null,
        siteAdded: false,
        trackingCode: '',
        copyButtonText: 'üìã Copy',
        hasExistingSites: false,
        
        async init() {
            // Check if we have existing sites
            try {
                const response = await fetch('/api/sites');
                const sites = await response.json();
                if (sites && sites.length > 0) {
                    // Sites exist, but user wants to add another
                    this.hasExistingSites = true;
                }
            } catch (err) {
                console.error('Error checking sites:', err);
            }
        },
        
        async addSite() {
            this.loading = true;
            this.error = null;
            
            try {
                // Normalize URL
                let url = this.siteUrl.trim();
                if (!url.startsWith('http://') && !url.startsWith('https://')) {
                    url = 'https://' + url;
                }
                
                const response = await fetch('/api/sites', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: this.siteName.trim(),
                        url: url
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to add site');
                }
                
                const data = await response.json();
                this.siteId = data.id;
                this.generateTrackingCode(data.id);
                this.siteAdded = true;
                
            } catch (err) {
                this.error = err.message || 'Failed to add site. Please try again.';
            } finally {
                this.loading = false;
            }
        },
        
        generateTrackingCode(siteId) {
            // Generate the tracking code for the site
            const baseUrl = window.location.origin;
            this.trackingCode = `<!-- Slimlytics Tracking Code -->
<script>
(function() {
    var script = document.createElement('script');
    script.src = '${baseUrl}/t.js';
    script.async = true;
    script.dataset.site = '${siteId}';
    document.head.appendChild(script);
})();
</script>
<!-- End Slimlytics Tracking Code -->`;
        },
        
        async copyTrackingCode() {
            try {
                await navigator.clipboard.writeText(this.trackingCode);
                this.copyButtonText = '‚úÖ Copied!';
                setTimeout(() => {
                    this.copyButtonText = 'üìã Copy';
                }, 2000);
            } catch (err) {
                this.copyButtonText = '‚ùå Failed';
                setTimeout(() => {
                    this.copyButtonText = 'üìã Copy';
                }, 2000);
            }
        }
    }
}
</script>

<style>
    [x-cloak] { display: none !important; }
    
    input:focus {
        outline: none;
        border-color: #3498db !important;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }
    
    button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
</style>